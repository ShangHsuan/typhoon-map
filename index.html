<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Hualien Typhoon Flood Risk Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* Alert bar */
        #alert-bar {
            width: 100%;
            background: red;
            color: white;
            text-align: center;
            padding: 6px;
            font-weight: bold;
        }

        /* Sidebar */
        #sidebar {
            position: absolute;
            left: 0;
            top: 40px;
            bottom: 0;
            width: 280px;
            background: #f7f7f7;
            overflow-y: auto;
            border-right: 2px solid #ccc;
            padding: 10px;
            z-index: 1000;
        }

        /* Map */
        #map {
            position: absolute;
        top: 30px;          
        left: 300px;       
        right: 0;
        bottom: 0;
        width: calc(100% - 300px);
        height: calc(100% - 30px);
        }


        .station-item {
            margin-bottom: 6px;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <!-- ALERT BAR -->
    <div id="alert-bar">üîî Loading CWA Emergency Alerts‚Ä¶</div>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <h3>üìç Stations & Risk</h3>
        <div id="station-list">Loading‚Ä¶</div>
    </div>

    <!-- MAP -->
    <div id="map"></div>


    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
        /* =======================
           Initialize Map
        ======================= */
        var map = L.map('map').setView([23.7, 121.4], 10);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
        }).addTo(map);


        /* =======================
           GeoJSON Points
        ======================= */
        function getColor(cluster) {
            if (cluster === 0) return "red";       // HIGH RISK
            if (cluster === 1) return "yellow";    // MEDIUM RISK
            return "green";                        // LOW RISK
        }

        fetch("risk_map.geojson")
            .then(res => res.json())
            .then(data => {
                
                // Add to map
                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 6,
                            fillColor: getColor(feature.properties.cluster_id),
                            color: "#000",
                            weight: 1,
                            fillOpacity: 0.8
                        });
                    }
                }).addTo(map);

                // Build sidebar list
                let list = document.getElementById("station-list");
                list.innerHTML = "";

                data.features.forEach(f => {
                    let name = f.properties.name || "Unnamed";
                    let risk =
                        f.properties.cluster_id === 0 ? "High" :
                        f.properties.cluster_id === 1 ? "Medium" : "Low";

                    let item = document.createElement("div");
                    item.className = "station-item";
                    item.innerHTML = `‚Ä¢ ${name} ‚Äî Risk <b>${risk}</b>`;
                    list.appendChild(item);
                });
            });


        /* =======================
           Emergency Alerts
        ======================= */
        fetch("https://alerts.ncdr.nat.gov.tw/JSONAtomFeed.ashx")
            .then(r => r.text())
            .then(xmlText => {
                document.getElementById("alert-bar").innerHTML =
                    "‚ö†Ô∏è No active emergency alerts at this moment";
            })
            .catch(() => {
                document.getElementById("alert-bar").innerHTML =
                    "‚ö†Ô∏è Unable to load emergency alerts";
            });

    </script>

</body>
</html>
