<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Hualien Typhoon Flood Risk Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>


    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        html, body { margin: 0; height: 100%; }
        #map { height: 100%; width: calc(100% - 260px); float: right; }


        #sidebar {
            width: 260px;
            height: 100%;
            background: #f8f8f8;
            padding: 12px;
            overflow-y: scroll;
            font-family: Arial;
            border-right: 1px solid #ccc;
            position: fixed;
            left: 0;
            top: 0;
        }


        .legend {
            background: white;
            padding: 8px;
            line-height: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .legend div {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .legend span {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            display: inline-block;
            border-radius: 50%;
        }
    </style>
</head>

<body>

<div id="sidebar">
    <h3>ðŸŒ€ Hualien Typhoon Dashboard</h3>
    <p>Real-time rainfall + risk classification.</p>

    <h4>Stations</h4>
    <ul id="stationList"></ul>
</div>

<div id="map"></div>

<script>

    // MAP SETUP

    var map = L.map('map').setView([23.7, 121.4], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);


    // RISK COLOR FUNCTION

    function getColor(cluster) {
        if (cluster === 0) return "red";      // HIGH
        if (cluster === 1) return "yellow";   // MEDIUM
        return "green";                       // LOW
    }

    // CLUSTER GROUP (Marker Clustering)

    var markerCluster = L.markerClusterGroup({
        animateAddingMarkers: true,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });

    // LOAD GEOJSON + POPULATE MAP & SIDEBAR

    fetch("risk_map.geojson")
        .then(r => r.json())
        .then(data => {

            let stationList = document.getElementById("stationList");

            data.features.forEach(f => {
                let latlng = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
                let name = f.properties.name || "Unknown Station";
                let county = f.properties.county || "";
                let town = f.properties.town || "";
                let risk = f.properties.cluster_id;

                let marker = L.circleMarker(latlng, {
                    radius: 8,
                    color: getColor(risk),
                    fillColor: getColor(risk),
                    fillOpacity: 0.85,
                    weight: 1
                }).bindPopup(`
                    <b>${name}</b><br>
                    County: ${county}<br>
                    Town: ${town}<br>
                    Risk Level: ${risk}<br>
                `);

                markerCluster.addLayer(marker);

                // Add to sidebar list
                let li = document.createElement("li");
                li.innerHTML = `${name} (${county} ${town}) - Risk ${risk}`;
                li.style.cursor = "pointer";
                li.onclick = () => map.setView(latlng, 14);
                stationList.appendChild(li);
            });

            map.addLayer(markerCluster);
        });


    // LEGEND CONTROL

    var legend = L.control({position: "bottomright"});

    legend.onAdd = function(map) {
        let div = L.DomUtil.create("div", "legend");
        div.innerHTML = `
            <div><span style="background:red"></span> High Risk</div>
            <div><span style="background:yellow"></span> Medium Risk</div>
            <div><span style="background:green"></span> Low Risk</div>
        `;
        return div;
    };

    legend.addTo(map);

</script>

</body>
</html>
