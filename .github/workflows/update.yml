name: Update Flood Risk Map

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update_map:
    runs-on: ubuntu-latest

    env:
      API: ${{ secrets.CWB_API_KEY }}

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install requests

    - name: Generate GeoJSON
      run: |
        python3 << 'EOF'
        import requests, json, os

        api = os.getenv("API")
        if not api:
            raise SystemExit("âŒ Secret API missing")

        url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization={api}"
        print("ðŸŒ URL:", url)

        r = requests.get(url)
        print("ðŸ“¡ Status:", r.status_code)

        data = r.json()

        if "records" not in data or "Station" not in data["records"]:
            raise SystemExit("âŒ ERROR: No station data found")

        stations = data["records"]["Station"]

        features = []

        for s in stations:
            name = s.get("StationName", "Unknown")
            geo = s.get("GeoInfo", {})
            coords = geo.get("Coordinates", [])

            # Select WGS84 coordinate set
            wgs84 = None
            for c in coords:
                if c.get("CoordinateName") == "WGS84":
                    wgs84 = c
                    break

            if not wgs84:
                continue  # skip station with no WGS84

            try:
                lat = float(wgs84["StationLatitude"])
                lon = float(wgs84["StationLongitude"])
            except Exception:
                continue

            features.append({
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [lon, lat]
                },
                "properties": {
                    "name": name,
                    "county": geo.get("CountyName"),
                    "town": geo.get("TownName")
                }
            })

        geojson = {
            "type": "FeatureCollection",
            "features": features
        }

        with open("risk_map.geojson", "w") as f:
            json.dump(geojson, f, ensure_ascii=False)

        print(f"âœ… Generated {len(features)} stations")
        EOF



    - name: Commit
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add risk_map.geojson
        git commit -m "Updated map" || echo "No changes"
        git push
