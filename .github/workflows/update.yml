name: Update Flood Risk Map

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update_map:
    runs-on: ubuntu-latest

    env:
      API: ${{ secrets.CWB_API_KEY }}

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install requests

    - name: Generate GeoJSON
      run: |
        python3 << 'EOF'
        import requests, json, os

        api = os.getenv("API")
        if not api:
            raise SystemExit("âŒ Secret API missing")

        url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization={api}"
        print("ðŸŒ URL:", url)

        r = requests.get(url)
        print("ðŸ“¡ Status:", r.status_code)

        data = r.json()

        # Check structure
        if "records" not in data or "Station" not in data["records"]:
            raise SystemExit("âŒ ERROR: 'Station' not found")

        stations = data["records"]["Station"]

        # â­ DEBUG: Print one sample station
        print("\nðŸ” SAMPLE STATION DATA:")
        print(json.dumps(stations[0], indent=2, ensure_ascii=False))

        raise SystemExit("â›” STOP â€” Identify correct coordinate fields above.")
        EOF


    - name: Commit
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add risk_map.geojson
        git commit -m "Updated map" || echo "No changes"
        git push
