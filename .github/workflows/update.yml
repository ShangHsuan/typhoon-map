name: Update Flood Risk Map

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update_map:
    runs-on: ubuntu-latest

    env:
      CWB_API_KEY: ${{ secrets.CWB_API_KEY }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install requests pandas numpy

    - name: Generate new GeoJSON
      run: |
        python3 << 'EOF'
        import requests, json

        api = "${CWB_API_KEY}"
        if not api:
            raise ValueError("âŒ API key is missing")

        print("ðŸ” Using API key:", api[:8] + "********")

        url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization={api}"
        print("ðŸŒ Fetching:", url)

        response = requests.get(url)
        print("ðŸ“¡ Status:", response.status_code)

        if response.status_code != 200:
            raise ValueError("âŒ API cannot be accessed:", response.text)

        data = response.json()
        locations = data["records"]["location"]

        features = []
        for loc in locations:
            lat = float(loc["lat"])
            lon = float(loc["lon"])
            rain1 = float(loc["weatherElement"][1]["elementValue"])
            rain24 = float(loc["weatherElement"][6]["elementValue"])

            if rain1 >= 40 or rain24 >= 200:
                cid = 0
            elif rain1 >= 10 or rain24 >= 80:
                cid = 1
            else:
                cid = 2

            features.append({
                "type": "Feature",
                "properties": {"cluster_id": cid},
                "geometry": {"type": "Point", "coordinates": [lon, lat]}
            })

        geojson = {"type": "FeatureCollection", "features": features}

        with open("risk_map.geojson", "w") as f:
            json.dump(geojson, f, indent=2)

        print("GeoJSON updated successfully.")
        EOF

    - name: Commit and push updated map
      run: |
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        git add risk_map.geojson
        git commit -m "Auto-update risk map" || echo "No changes"
        git push
