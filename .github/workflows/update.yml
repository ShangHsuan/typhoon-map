name: Update Flood Risk Map

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update_map:
    runs-on: ubuntu-latest

    env:
      API: ${{ secrets.CWB_API_KEY }}

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install requests

    - name: Generate GeoJSON
      run: |
        python3 << 'EOF'
        import requests, json, os

        api = os.getenv("API")
        if not api:
            raise SystemExit("âŒ Secret API missing")

        url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization={api}"
        print("ðŸŒ URL:", url)

        r = requests.get(url)
        print("ðŸ“¡ Status:", r.status_code)

        data = r.json()

        # Correct structure uses "Station"
        if "records" not in data or "Station" not in data["records"]:
            raise SystemExit("âŒ ERROR: 'Station' field not found in API")

        stations = data["records"]["Station"]

        features = []
        for st in stations:
            
            # Latitude/Longitude fields
            lat = float(st["StationLatitude"])
            lon = float(st["StationLongitude"])

            # Weather elements â†’ we extract rainfall:
            rain1 = 0
            rain24 = 0
            for elem in st.get("WeatherElement", []):
                if elem["ElementName"] == "Now":
                    rain1 = float(elem["ElementValue"])
                if elem["ElementName"] == "24hr":
                    rain24 = float(elem["ElementValue"])

            # Assign cluster based on rainfall thresholds
            if rain1 >= 40 or rain24 >= 200:
                cid = 0
            elif rain1 >= 10 or rain24 >= 80:
                cid = 1
            else:
                cid = 2

            features.append({
                "type": "Feature",
                "properties": {
                    "cluster_id": cid,
                    "station": st["StationName"]
                },
                "geometry": {"type": "Point", "coordinates": [lon, lat]}
            })

        geojson = {"type": "FeatureCollection", "features": features}

        with open("risk_map.geojson", "w") as f:
            json.dump(geojson, f)

        print("âœ… GeoJSON updated successfully!")
        EOF

    - name: Commit
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add risk_map.geojson
        git commit -m "Updated map" || echo "No changes"
        git push
